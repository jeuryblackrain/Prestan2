<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Préstamos Semanal</title>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; }
        .container { width: 80%; margin: auto; background: white; padding: 20px; border-radius: 10px; }
        input, select, button { margin: 10px; padding: 10px; width: 80%; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Gestión de Préstamos</h2>
        <button onclick="mostrarFormularioCliente()">Registrar Cliente</button>
        <button onclick="mostrarFormularioPrestamo()">Nuevo Préstamo</button>
        <table id="tablaPrestamos">
            <thead>
                <tr><th>Cliente</th><th>Monto</th><th>Saldo</th><th>Fecha</th><th>Acciones</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
             const firebaseConfig = {
                  apiKey: "AIzaSyAoR5nIZScneP9wNnzbveqXFxcSMhdF4_U",
                  authDomain: "prestan2-6059e.firebaseapp.com",
                  databaseURL: "https://prestan2-6059e-default-rtdb.firebaseio.com",
                  projectId: "prestan2-6059e",
                  storageBucket: "prestan2-6059e.firebasestorage.app",
                  messagingSenderId: "758979429000",
                  appId: "1:758979429000:web:46133ec0e3a8bf628b553d"
            };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        function mostrarFormularioCliente() {
            let nombre = prompt("Nombre Completo");
            let cedula = prompt("Cédula (solo números, se formateará)");
            let telefono = prompt("Teléfono (solo números, se formateará)");
            let direccion = prompt("Dirección");
            
            cedula = cedula.replace(/\D/g, "").replace(/(\d{3})(\d{7})(\d{1})/, "$1-$2-$3");
            telefono = telefono.replace(/\D/g, "").replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
            
            db.ref("clientes").push({ nombre, cedula, telefono, direccion });
            alert("Cliente registrado con éxito");
        }

        function mostrarFormularioPrestamo() {
            db.ref("clientes").once("value", snapshot => {
                let clientes = snapshot.val();
                let opciones = Object.entries(clientes).map(([id, c]) => `${id}: ${c.nombre}`).join("\n");
                let idCliente = prompt(`Seleccione cliente (ID):\n${opciones}`);
                let monto = parseFloat(prompt("Monto del préstamo"));
                let usuario = localStorage.getItem("usuario");
                let fecha = new Date().toLocaleDateString();
                
                db.ref("prestamos").push({ idCliente, nombreCliente: clientes[idCliente].nombre, monto, saldo: monto, usuario, fecha });
                alert("Préstamo registrado");
            });
        }
        
        function cargarPrestamos() {
            db.ref("prestamos").on("value", snapshot => {
                let tbody = document.querySelector("#tablaPrestamos tbody");
                tbody.innerHTML = "";
                snapshot.forEach(child => {
                    let p = child.val();
                    tbody.innerHTML += `<tr>
                        <td>${p.nombreCliente}</td>
                        <td>${p.monto} RD$</td>
                        <td>${p.saldo} RD$</td>
                        <td>${p.fecha}</td>
                        <td><button onclick="realizarAbono('${child.key}')">Abonar</button></td>
                    </tr>`;
                });
            });
        }
        
        function realizarAbono(idPrestamo) {
            db.ref("prestamos/" + idPrestamo).once("value", snapshot => {
                if (snapshot.exists()) {
                    let p = snapshot.val();
                    let abono = p.monto / 10;
                    let nuevoSaldo = p.saldo - abono;
                    db.ref("prestamos/" + idPrestamo).update({ saldo: nuevoSaldo });
                    imprimirFactura(p, abono);
                    alert("Pago realizado. Nuevo saldo: " + nuevoSaldo);
                }
            });
        }
        
        function imprimirFactura(prestamo, pago) {
            let fecha = new Date().toLocaleDateString();
            let factura = `<html><head><title>Factura</title></head><body>
                <h2>Factura de Pago</h2>
                <p>Fecha: ${fecha}</p>
                <p>Cliente: ${prestamo.nombreCliente}</p>
                <p>Monto Total: ${prestamo.monto} RD$</p>
                <p>Pago realizado: ${pago} RD$</p>
                <p>Saldo Restante: ${prestamo.saldo - pago} RD$</p>
                <button onclick="window.print()">Imprimir</button>
            </body></html>`;
            let ventana = window.open("", "_blank");
            ventana.document.write(factura);
            ventana.document.close();
        }
        
        cargarPrestamos();
    </script>
</body>
</html>
