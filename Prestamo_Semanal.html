<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Préstamos Semanales</title>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        input, select, button { margin: 5px; padding: 10px; width: 90%; }
        .factura { display: none; text-align: left; border: 1px solid #000; padding: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Registro de Cliente</h2>
        <input type="text" id="nombre" placeholder="Nombre Completo">
        <input type="text" id="cedula" placeholder="Cédula" maxlength="13" oninput="formatearCedula(this)">
        <input type="text" id="telefono" placeholder="Teléfono" maxlength="12" oninput="formatearTelefono(this)">
        <input type="text" id="direccion" placeholder="Dirección">
        <button onclick="registrarCliente()">Registrar Cliente</button>

        <h2>Nuevo Préstamo</h2>
        <select id="clientes"></select>
        <input type="number" id="monto" placeholder="Monto del Préstamo">
        <button onclick="otorgarPrestamo()">Otorgar Préstamo</button>

        <h2>Realizar Abono</h2>
        <select id="prestamos"></select>
        <button onclick="abonar()">Abonar e Imprimir Factura</button>

        <div class="factura" id="factura">
            <pre id="facturaContenido"></pre>
            <button onclick="imprimirFactura()">Imprimir</button>
        </div>
    </div>

    <script>
               const firebaseConfig = {
          apiKey: "AIzaSyAoR5nIZScneP9wNnzbveqXFxcSMhdF4_U",
          authDomain: "prestan2-6059e.firebaseapp.com",
          databaseURL: "https://prestan2-6059e-default-rtdb.firebaseio.com",
          projectId: "prestan2-6059e",
          storageBucket: "prestan2-6059e.firebasestorage.app",
          messagingSenderId: "758979429000",
          appId: "1:758979429000:web:46133ec0e3a8bf628b553d"
    };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        function formatearCedula(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3);
            if (value.length > 11) value = value.slice(0, 11) + '-' + value.slice(11);
            input.value = value;
        }
        
        function formatearTelefono(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3);
            if (value.length > 7) value = value.slice(0, 7) + '-' + value.slice(7);
            input.value = value;
        }
        
        function registrarCliente() {
            const cliente = {
                nombre: document.getElementById("nombre").value,
                cedula: document.getElementById("cedula").value,
                telefono: document.getElementById("telefono").value,
                direccion: document.getElementById("direccion").value
            };
            db.ref("clientes").push(cliente);
        }
        
        function otorgarPrestamo() {
            const clienteID = document.getElementById("clientes").value;
            const monto = parseFloat(document.getElementById("monto").value);
            const cuotas = monto / 10;
            const prestamo = { clienteID, monto, cuotas, restantes: 13, usuario: "Admin", fecha: new Date().toLocaleDateString() };
            db.ref("prestamos").push(prestamo);
        }
        
        function abonar() {
            const prestamoID = document.getElementById("prestamos").value;
            db.ref("prestamos/" + prestamoID).once("value", snapshot => {
                let prestamo = snapshot.val();
                if (prestamo.restantes > 0) {
                    prestamo.restantes -= 1;
                    db.ref("prestamos/" + prestamoID).update(prestamo);
                    generarFactura(prestamo);
                }
            });
        }
        
        function generarFactura(prestamo) {
            document.getElementById("facturaContenido").textContent = `
-------------------------------------------------
                Prestan2
   La Solucion a tus problemas
-------------------------------------------------
Fecha: ${new Date().toLocaleDateString()}    Hora: ${new Date().toLocaleTimeString()}
Factura N°: ${Math.floor(Math.random() * 1000000)}

Cliente: ${prestamo.clienteID}
Usuario: ${prestamo.usuario}
-------------------------------------------------
Cuota N°: ${13 - prestamo.restantes}/13
Monto Abonado: ${prestamo.cuotas}
Cuotas Restantes: ${prestamo.restantes}
-------------------------------------------------
Gracias por su pago.
-------------------------------------------------`;
            document.getElementById("factura").style.display = "block";
        }
        
        function imprimirFactura() {
            let contenido = document.getElementById("facturaContenido").textContent;
            let ventana = window.open('', '', 'width=400,height=600');
            ventana.document.write(`<pre>${contenido}</pre>`);
            ventana.document.close();
            ventana.print();
        }
    </script>
</body>
</html>
